name: CI Tests and Quality Checks

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/**"
    tags:
      - "v*"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/**"
  workflow_dispatch:

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-test: ${{ steps.changes.outputs.should-test }}
      test-reason: ${{ steps.changes.outputs.test-reason }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æµ‹è¯•
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-test=true" >> $GITHUB_OUTPUT
            echo "test-reason=æ‰‹åŠ¨è§¦å‘" >> $GITHUB_OUTPUT
            echo "ðŸ”§ æ‰‹åŠ¨è§¦å‘æµ‹è¯•"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "should-test=true" >> $GITHUB_OUTPUT
            echo "test-reason=æ ‡ç­¾æŽ¨é€" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ æ ‡ç­¾æŽ¨é€ï¼Œæ‰§è¡Œæµ‹è¯•"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-test=true" >> $GITHUB_OUTPUT
            echo "test-reason=Pull Request" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ PRåˆ›å»ºï¼Œæ‰§è¡Œæµ‹è¯•"
          else
            # æ£€æŸ¥æºç æ˜¯å¦æœ‰å˜æ›´
            if git diff --name-only HEAD~1 | grep -E "(src/|requirements\.txt|\.github/workflows/)" > /dev/null; then
              echo "should-test=true" >> $GITHUB_OUTPUT
              echo "test-reason=æºç å˜æ›´" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œæ‰§è¡Œæµ‹è¯•"
              echo "å˜æ›´çš„æ–‡ä»¶:"
              git diff --name-only HEAD~1 | grep -E "(src/|requirements\.txt|\.github/workflows/)"
            else
              echo "should-test=false" >> $GITHUB_OUTPUT
              echo "test-reason=æ— ç›¸å…³å˜æ›´" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æœªæ£€æµ‹åˆ°ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æµ‹è¯•"
            fi
          fi

  test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-test == 'true'
    strategy:
      matrix:
        python-version: [3.11]

    steps:
      - name: ðŸ“‹ æµ‹è¯•ä¿¡æ¯
        run: |
          echo "ðŸ§ª å¼€å§‹æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥"
          echo "ðŸ“ è§¦å‘åŽŸå› : ${{ needs.check-changes.outputs.test-reason }}"
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 autopep8 isort

      - name: ä»£ç æ ¼å¼æ£€æŸ¥ (autopep8)
        continue-on-error: true
        run: |
          pip install autopep8
          autopep8 --diff --exit-code **/*.py || echo "autopep8 failed" >> result.log

      - name: å¯¼å…¥æŽ’åºæ£€æŸ¥ (isort)
        continue-on-error: true
        run: |
          isort --check-only --diff src/ || echo "isort failed" >> result.log

      - name: ä»£ç é£Žæ ¼æ£€æŸ¥ (Flake8)
        continue-on-error: true
        run: |
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "flake8 strict failed" >> result.log
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || echo "flake8 loose failed" >> result.log

      - name: ç±»åž‹æ£€æŸ¥
        continue-on-error: true
        run: |
          pip install mypy
          mypy src/ --ignore-missing-imports || echo "mypy failed" >> result.log

      - name: æ£€æŸ¥æ‰€æœ‰ç»“æžœ
        run: |
          if [ -f result.log ]; then
            echo "âŒ æœ‰æ­¥éª¤å¤±è´¥ï¼š"
            cat result.log
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
          fi

  # æµ‹è¯•æ€»ç»“
  test-summary:
    runs-on: ubuntu-latest
    needs: [check-changes, test]
    if: always()

    steps:
      - name: æµ‹è¯•æ€»ç»“
        run: |
          echo "## ðŸ§ª CI æµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘åŽŸå› **: ${{ needs.check-changes.outputs.test-reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦æ‰§è¡Œ**: ${{ needs.check-changes.outputs.should-test }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check-changes.outputs.should-test }}" == "true" ]]; then
            if [[ "${{ needs.test.result }}" == "success" ]]; then
              echo "- **æµ‹è¯•ç»“æžœ**: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "æ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥å·²é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.test.result }}" == "failure" ]]; then
              echo "- **æµ‹è¯•ç»“æžœ**: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æ£€æŸ¥ä»£ç è´¨é‡é—®é¢˜å¹¶ä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **æµ‹è¯•ç»“æžœ**: â­ï¸ è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æœªæ£€æµ‹åˆ°ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œå·²è·³è¿‡æµ‹è¯•ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
